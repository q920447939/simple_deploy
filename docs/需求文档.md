# 简易 Ansible 部署升级桌面工具（Simple Deploy）需求文档（v1）

最后更新：2026-01-13  
目标平台：Windows / Linux 桌面应用（单人使用）

---

# 总体需求描述

## 1. 背景
小批量 Linux 服务器（可能 x86/arm），软件以分布式/集群方式部署（含纯命令与 Docker 场景）。人工重复操作慢且易错，需要通过 Ansible Playbook 进行标准化部署与升级，并沉淀执行记录与日志。

## 2. 目标
- 客户端本地管理：项目、服务器、playbook、任务、执行批次。
- 执行时：将 playbook 与本次相关业务文件发送到“控制端服务器”（已安装 Ansible），由控制端 SSH 直连被控端执行。
- 记录结果：至少记录 Ansible 执行退出码与完整日志；可选记录业务状态（由 playbook 产出）。

## 3. 关键假设/前置条件
- 控制端：Linux + 已安装 `ansible-playbook`，可 SSH 直连所有被控端。
- 被控端：Linux + Python >= 3.8。
- 认证方式：root/密码（不考虑密钥、跳板机、多段网络）。
- 单人使用：不做登录、RBAC、权限隔离；配置与密码以本地明文文件保存。

## 4. 非目标（v1 不做）
- 不做 Web 化/浏览器访问（仅桌面应用）。
- 不做自动排队调度（不需要“排队中”状态）。
- 不做断点续跑/自动重试（失败后人工修复后重跑）。
- 不做复杂 inventory 分组/业务角色模型。
- 不做密码加密与日志归档下载/清理策略。

## 5. 名词与模型
- 项目：隔离单元。
- 服务器：两类逻辑实体：控制端 / 被控端；同一物理机可对应两条记录。
- Playbook：YAML 文件 + 元信息。
- 任务（Task）：绑定一个 playbook，并声明文件槽位（可选）。
- 执行批次（Batch）：选择 1 控制端 + N 被控端 + 有序任务列表；批次可多次执行。
- 执行记录（Run）：批次的一次实际运行；日志/结果按 Run 保留。

## 6. 状态机
### 6.1 批次状态（Batch）
仅三态：
- 暂停：允许编辑批次配置（控制端/被控端/任务顺序/文件绑定）。
- 运行中：该批次当前有且仅有 1 个 Run 运行；禁止编辑与重复执行。
- 结束：最近一次 Run 已结束（成功/失败）；允许“重置为暂停”后再编辑并重新执行。

并发规则：
- 同一批次：互斥（同一时间最多 1 个 Run）。
- 同一项目：不同批次可并发运行。

### 6.2 Run 状态
- 运行中
- 结束（成功/失败）

## 7. 功能清单（v1）
### 7.1 项目管理
- 项目列表、新增、编辑、删除（名称、简介、时间戳）。

### 7.2 服务器管理（项目内）
- 控制端列表：可选为执行节点。
- 被控端列表：可选为目标主机。
- 增删改查字段：名称、IP、端口、用户名、密码、启用状态。
- 允许同 IP 两条记录（控制端/被控端两个逻辑实体）。

### 7.3 Playbook 管理（项目内）
- 约定：playbook 文件存放在项目目录下。
- 列表/新增/在线编辑/删除/批量删除/查看。
- 保存时：做 YAML 基础语法校验（错误可定位到行号更佳）。

### 7.4 任务（Task）管理（项目内）
- 任务定义：任务名/简述 + 绑定 playbook + 文件槽位声明（可选）。
- 文件槽位仅声明“必选/可多文件/槽位名”，不关心文件类型与目标路径（交给 playbook 处理）。

### 7.5 批次（Batch）管理（项目内）
- 创建批次必须选择：1 控制端、>=1 被控端、>=1 任务（并可排序）。
- 暂停状态下允许编辑。
- 执行：
  - 执行前对必选文件槽位要求用户选择文件并落盘；
  - 创建新的 Run（保留历史 Run 与日志）；
  - 任一任务失败即停止，批次进入结束状态。
- 重置为暂停：仅针对批次（不修改历史 Run）。

### 7.6 日志与结果展示
- 批次详情：任务进度条（等待/执行中/成功/失败）+ 日志窗口。
- 默认展示：当前执行任务日志；执行结束后展示最后一个任务日志。
- 支持切换：任务维度日志、历史 Run 维度日志。
- 实时展示：以最简单实现为准（轮询追加即可）。

## 8. 成功/失败与业务状态
- Ansible 成败：以 `ansible-playbook` 退出码判定（0 成功，非0 失败）。
- 业务状态（可选）：由 playbook 产出 JSON 文件，客户端读取后保存到 Run 结果；缺失则记为 `unknown`。

---

# 技术栈描述
- Flutter Desktop（Windows/Linux）
- 本地文件存储（JSON + 目录，不引入数据库）
- SSH/SFTP 下发执行包到控制端，并触发远程命令执行

---

# 开发约束
- 不增加独立后端服务；桌面应用承担 UI + 执行器职责。
- 单人使用；不做鉴权/RBAC；本地明文保存密码（需提示风险）。
- 支持项目内并发：不同批次可并发，同批次互斥。

---

# 视觉约束
- UI采用 shadcn_flutter(https://pub.dev/packages/shadcn_flutter)
- 左侧导航 + 右侧列表/详情（master-detail）。
- 批次详情必须包含：任务进度条 + 日志查看（支持任务切换、Run 切换）。
- Playbook 编辑器：v1 允许仅文本编辑（不强制高亮）。

---

# 其他约束
- 控制端/被控端网络可达为硬前提；错误提示需可定位（SSH、解包、退出码等）。
- 本地 JSON 写入需原子化，避免断电/崩溃损坏。
- 提供“强制解锁/重置”为异常恢复入口。

---

# 任务列表
## 任务1
- 初始化 Flutter Desktop 工程与基础依赖
## 任务2
- 本地存储与数据模型（JSON + 原子写 + 锁）
## 任务3
- 项目管理 UI
## 任务4
- 服务器管理 UI（含控制端连接测试）
## 任务5
- Playbook 管理与在线编辑（含 YAML 校验）
## 任务6
- 任务（Task）管理（playbook 绑定 + 文件槽位）
## 任务7
- 批次（Batch）管理（状态机 + 重置为暂停）
## 任务8
- 执行引擎（打包下发、远程执行、结果采集）
## 任务9
- 日志与进度展示（任务维度 + Run 维度）
## 任务10
- 健壮性与验收用例

