# 简易 Ansible 部署升级桌面工具（Simple Deploy）任务列表（v1）

最后更新：2026-01-13

---

# 总体需求描述
本文件仅列出可执行的开发任务拆分（WBS），详细需求与技术约定见：
- `docs/需求文档.md`
- `docs/技术文档.md`

---

# 技术栈描述
- Flutter Desktop（Windows/Linux）+ 本地 JSON 存储 + SSH/SFTP 下发到控制端执行 Ansible

---

# 开发约束
- 不增加独立后端服务；所有逻辑在桌面客户端内完成

---

# 视觉约束
- 批次详情：任务进度条 + 日志查看为必做

---

# 其他约束
- 同一批次互斥，不同批次可并发

---

# 任务列表

## 任务1：项目初始化与工程规范
- 创建 Flutter Desktop 工程（Windows/Linux），确认能在两端启动空窗口
- 规划目录分层（建议）：`lib/model/`、`lib/storage/`、`lib/services/ssh/`、`lib/services/run_engine/`、`lib/ui/`
- 定义统一的错误与提示规范：错误码/错误标题/建议处理方式（便于 UI 统一弹窗/Toast）
- 定义运行时日志策略（客户端自身日志）：写入本地 `app_logs/`（用于排查 SSH/打包/执行器问题）
- 文档落地：`docs/需求文档.md`、`docs/技术文档.md`、`docs/任务列表.md`（已完成）
- 验收标准
  - Windows/Linux 均可运行桌面应用并读写应用数据目录
  - 目录结构清晰，后续模块能按分层落地，不出现“UI 里直接写 SSH/文件逻辑”的耦合

## 任务2：数据模型与本地存储层
- 定义模型与字段（最少包含）
  - `Project`：`id/name/description/createdAt/updatedAt/version`
  - `Server`：`id/name/type(control|managed)/ip/port/username/password/enabled`
  - `PlaybookMeta`：`id/name/description/relativePath/updatedAt`
  - `Task`：`id/name/description/playbookId/fileSlots[]`
  - `Batch`：`id/name/description/status(paused|running|ended)/controlServerId/managedServerIds[]/taskOrder[]/createdAt/updatedAt/lastRunId?`
  - `Run`：`id/projectId/batchId/startedAt/endedAt?/status(running|ended)/result(success|failed)/taskResults[]/ansibleSummary?/bizStatus?/errorSummary?`
- 约定 ID 生成：UUID v4（或时间戳+随机数，但必须全局唯一）
- 目录初始化：首次启动创建应用根目录与 `projects/` 子目录
- JSON 存储与索引
  - 按项目分目录；每个列表文件（servers/tasks/playbooks）用一个 JSON 文件保存
  - 批次用独立文件：`batches/<batch_id>.json`（减少并发写冲突）
  - Run 用独立文件：`runs/<run_id>.json`（只写一次或少量追加）
- 原子写入实现
  - 写 `*.tmp` 后 rename 覆盖，避免崩溃导致 JSON 半写入
  - 失败要返回明确错误（权限不足/磁盘满/路径非法）
- 批次级锁（同批次互斥）
  - `locks/batch_<batch_id>.lock` 使用“原子创建（create-new）”
  - 锁内容记录：`run_id/pid/createdAt`（便于强制解锁时展示信息）
  - 提供“强制解锁”能力（删除 lock 文件，并将 batch.status 重置为 paused）
- 验收标准
  - 任意时刻强制杀进程后重启，不会出现 JSON 解析失败（除非磁盘损坏）
  - 同批次并发点击“执行”只能成功一次，另一次得到“已在运行中”的明确提示

## 任务3：项目管理 UI
- 项目列表页
  - 展示项目名称/简介/更新时间
  - 支持搜索（按名称）与排序（按更新时间）
- 新增/编辑项目
  - 必填：名称；可选：简介
  - 名称冲突提示（建议同名禁止，或自动加后缀，二选一提前定）
- 删除项目
  - 二次确认（明确会删除该项目所有服务器/playbook/批次/Run/日志）
- 项目上下文切换
  - 左侧导航显示当前项目
  - 切换项目时：关闭当前正在编辑的 playbook（如有未保存提示）
- 验收标准
  - 创建/切换/删除项目流程顺畅，不发生数据串项目

## 任务4：服务器管理 UI
- 列表组织
  - 两个标签页：控制端 / 被控端（或一个列表加筛选器）
  - 展示：name、ip:port、username、enabled、最后测试时间/结果（可选）
- 新增/编辑服务器
  - 校验：IP/域名格式、端口范围、必填项
  - 密码输入框默认隐藏（提供“显示/隐藏”按钮）
  - 允许同 IP 两条记录（控制端/被控端分别保存）
- 控制端连接测试
  - 客户端 -> 控制端：SSH 登录测试（可选做 `uname -a` 回显）
  - 测试失败时展示：原因（认证失败/网络不可达/超时/握手失败）
- 验收标准
  - 能稳定验证“控制端可连通”，并输出可操作的失败原因

## 任务5：Playbook 管理 UI + 编辑器
- Playbook 列表
  - 展示：名称/简述/文件名/更新时间
  - 支持新增、删除、批量删除（批量必须二次确认）
- 新增 playbook
  - 选择文件名（自动加 `.yml`/`.yaml`）
  - 初始化内容可提供最小模板（空的 play）
- 在线编辑器（v1 纯文本即可）
  - 未保存变更提示（离开页面/切换项目/关闭应用时）
  - 保存动作写入 `playbooks/` 对应文件，并更新 `playbooks.json` 的更新时间
- YAML 校验
  - 保存前解析 YAML：失败则阻止保存并提示错误位置（若库支持行号）
  - （可选）限制文件大小与行数，避免 UI 卡顿
- 验收标准
  - 任意错误 YAML 无法保存；正确 YAML 能保存并在列表刷新元信息

## 任务6：任务（Task）管理
- 任务列表
  - 展示：名称、绑定 playbook、是否需要文件槽位
- 新增/编辑任务
  - 绑定 playbook（下拉选择项目内 playbook）
  - 文件槽位配置
    - 槽位名命名规范（建议：`[a-zA-Z0-9_]+`）
    - `required`（必选）/`multi`（多文件）
  - 删除任务前检查：是否被批次引用（引用则提示并阻止/或允许强制删除并级联移除，二选一）
- 验收标准
  - 任务与 playbook 引用关系始终一致（playbook 删除时能提示受影响任务）

## 任务7：批次（Batch）管理
- 批次列表
  - 展示：名称、状态（暂停/运行中/结束）、最后一次 Run 结果/时间
  - 支持按状态筛选
- 新增/编辑批次（仅 paused 可编辑）
  - 选择控制端（单选，必须）
  - 选择被控端（多选，至少 1）
  - 选择任务（多选），支持拖拽排序（或上下移动按钮）
  - 保存时校验：控制端/被控端/任务都不为空
- 状态机实现
  - 点击执行：paused -> running（创建新的 Run，并加批次锁）
  - Run 结束：running -> ended
  - 重置为暂停：ended -> paused（释放锁、允许编辑；历史 Run 只读保留）
- 异常恢复入口
  - “强制重置为暂停”（用于 app 崩溃后锁遗留）：删除锁文件 + batch.status=paused
- 验收标准
  - 批次运行中不可编辑；结束后可一键重置并再次编辑/执行

## 任务8：Run 创建与文件绑定
- Run 创建时机：点击“执行”后立即创建（先校验/收集文件，再真正开始远程执行）
- 文件绑定交互
  - 汇总展示本批次所有任务的文件槽位需求（按任务分组）
  - 对 `required=true` 的槽位：未选择文件则禁止开始执行
  - 对 `multi=false` 的槽位：只能选 1 个文件；`multi=true` 支持多选与移除
- 落盘策略
  - 将用户选择的文件复制到：`run_artifacts/<run_id>/task_<index>/<slot_name>/...`
  - 保留原始文件名；若冲突自动重命名（如追加 `_1`）
- vars.json 生成
  - 写入 `run_id`、`run_dir`（控制端路径）、`files`（相对路径映射）
  - 将映射写入 Run 记录，保证日志回溯时可看到“当时用的是哪些文件”
- 验收标准
  - 运行时不依赖用户原始文件路径（即便原文件被删除/移动，Run 仍可复现输入）

## 任务9：执行引擎（控制端协议实现）
- 预检（开始执行前）
  - SSH 连接控制端成功
  - 控制端依赖检查：`ansible-playbook --version`、`sshpass -V`
  - 控制端创建 run_dir：`/tmp/simple_deploy/<project_id>/<run_id>/`
- 生成并下发执行包
  - 生成 `inventory.ini`（all 主机集合，带 root/密码与 python3）
  - 收集 playbooks（项目目录 `playbooks/`）与本次 run_artifacts
  - 生成 `vars.json`
  - 打包 `bundle.zip` 并 SFTP 上传至控制端 run_dir
- 控制端侧解包与执行（两种实现任选其一，v1 选最简单）
  - 方案A（推荐）：上传 `run.sh`，远程执行 `bash run.sh`，脚本负责解包+逐任务执行+落 `results/run_result.json`
  - 方案B：客户端逐条远程命令执行（解包、循环执行 ansible-playbook），并在本地维护结果文件
- 逐任务执行与失败策略
  - 对每个任务按顺序执行其 playbook
  - 将 stdout/stderr 追加写入控制端 `logs/task_<index>.log`
  - 任何一个任务退出码非0：立刻停止后续任务，Run 失败
- 结果回收
  - 执行结束后拉取：控制端 `logs/` -> 本地 `run_logs/<run_id>/`
  - 解析并保存：`results/run_result.json`
  - 若存在：`results/biz_status.json` 解析保存；缺失则 bizStatus=unknown
- 资源释放
  - 更新 Run 记录（endedAt/result/错误摘要）
  - 更新 Batch 状态为 ended，并写入 lastRunId
  - 删除批次锁文件（或标记释放）
- 验收标准
  - 在控制端真实执行 playbook 成功/失败都能在本地完整记录：退出码、任务级状态、日志、（可选）业务状态

## 任务10：日志与进度展示
- 批次详情页
  - 任务进度条：任务节点颜色区分（等待/执行中/成功/失败）
  - 当前 Run 运行中时：默认定位到“执行中任务”的日志
  - Run 结束时：默认定位到“最后一个任务”的日志
- 日志查看
  - 支持任务切换：切换即显示对应 `task_<index>.log`
  - 支持历史 Run 切换：从 Run 列表选择 run_id 后加载其日志目录
- 实时更新（v1 最简单）
  - 若采用“执行后拉取”：运行中展示“控制端执行中…”占位，结束后拉取并展示
  - 若采用“轮询追加”：定时拉取控制端日志的增量并追加到本地文件，再刷新 UI
- 大日志防卡顿
  - 默认只渲染最后 N 行（如 2000 行），并提供“加载更多”
- 验收标准
  - 日志可稳定查看与切换，不因大文件导致 UI 卡死

## 任务11：自检与错误提示
- 自检入口
  - 在控制端详情或全局设置提供“环境自检”
  - 自检项：SSH 可连、ansible 存在、sshpass 存在、磁盘可写（run_dir 创建/写入）
- 错误分层与提示
  - 连接类：网络/认证/超时
  - 依赖类：ansible/sshpass 缺失
  - 执行类：playbook 退出码非0（提示去看对应 task log）
  - 协议类：bundle 解包失败、文件缺失、vars.json 不一致
- 验收标准
  - 出错时用户能通过提示快速定位：是“连不上控制端/缺依赖/任务失败”

## 任务12：验收用例（手工）
- 用例1：单任务成功
  - 配置 1 控制端 + 1 被控端 + 1 任务
  - 执行后 Run=成功、日志可见、batch=结束
- 用例2：中途失败停止
  - 批次包含 2 个任务：任务1成功、任务2故意失败
  - 期望：任务2失败后停止；Run=失败；无任务3/后续执行痕迹
- 用例3：同项目多批次并发
  - 创建两个批次（不同 batch_id），同时点击执行
  - 期望：两个 Run 同时运行；日志与结果互不串；无锁冲突
- 用例4：同批次互斥
  - 同一批次连续点击执行两次
  - 期望：第二次提示“批次运行中”，不会创建第二个 running Run
- 用例5：结束后重置并替换文件重跑
  - 批次执行结束 -> 重置为暂停 -> 替换文件 -> 再执行
  - 期望：生成新的 run_id；历史 Run 可切换查看；本次文件映射不同
- 用例6：异常恢复（锁遗留）
  - 执行中强制关闭应用 -> 重启 -> 强制重置为暂停
  - 期望：锁被清理；批次可再次执行；历史 run 保留

## 任务13：发布与交付（桌面应用）
- Windows 构建产物输出（exe/msix 二选一，v1 先用默认构建产物也可）
- Linux 构建产物输出（AppImage/zip 二选一，v1 先用 zip 也可）
- 在应用内“关于/版本信息”页展示版本号与数据目录路径
- 提供最小《使用说明》：控制端依赖、首次配置步骤、常见错误处理
- 验收标准
  - Windows/Linux 均可运行发布包，配置与日志能正常写入数据目录
